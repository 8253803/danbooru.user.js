// ==UserScript==
// @name Danbooru - Blacklist2
// @version 20231106011256
// @author hdk5
// @supportURL https://github.com/hdk5/danbooru.user.js/issues
// @match *://*.donmai.us/*
// @downloadURL https://github.com/hdk5/danbooru.user.js/raw/master/dist/blacklist2.user.js
// @grant none
// @homepageURL https://github.com/hdk5/danbooru.user.js
// @namespace https://github.com/hdk5/danbooru.user.js
// @updateURL https://github.com/hdk5/danbooru.user.js/raw/master/dist/blacklist2.meta.js
// ==/UserScript==

(()=>{"use strict";class t{static get SUBCLASSES(){return[e,s,n,c,a,i,r,u,l,h]}static parse(t){for(const e of this.SUBCLASSES){const s=e.parse(t);if(null!==s)return s}return null}static parseValue(t){return Number.parseInt(t)}}class e extends t{ranges;constructor(t){super(),this.ranges=t}static parse(e){if(null===/[, ]/.exec(e))return null;const s=[];for(const n of e.split(/[, ]+/)){const e=t.parse(n);if(null===e)return null;s.push(e)}return new this(s)}includes(t){return this.ranges.some((e=>e.includes(t)))}}class s extends t{start;end;static REGEX=/^(.+?)\.\.\.(.+)/;constructor(t,e){super(),this.start=t,this.end=e}static parse(t){const e=this.REGEX.exec(t);return null===e?null:new this(this.parseValue(e[1]),this.parseValue(e[2]))}includes(t){return this.start<=t&&t<this.end}}class n extends s{static REGEX=/^(.+?)\.\.(.+)/;includes(t){return this.start<=t&&t<=this.end}}class r extends t{value;static REGEX=/^>(.+)/;constructor(t){super(),this.value=t}static parse(t){const e=this.REGEX.exec(t);return null===e?null:new this(this.parseValue(e.filter(Boolean)[1]))}includes(t){return t>this.value}}class a extends r{static REGEX=/^<(.+)/;includes(t){return t<this.value}}class i extends r{static REGEX=/^(?:>=(.+)|(.+)\.\.$)/;includes(t){return t>=this.value}}class c extends r{static REGEX=/^(?:<=(.+)|\.\.(.+))/;includes(t){return t<=this.value}}class l extends t{static VALUE="none";static parse(t){return t!==this.VALUE?null:new this}includes(t){return Number.isNaN(t)}}class u extends l{static VALUE="any";includes(t){return!super.includes(t)}}class h extends t{value;constructor(t){super(),this.value=t}static parse(t){return new this(this.parseValue(t))}includes(t){return t===this.value}}class o{value;constructor(t){this.value=t}static get NAMES(){return Object.keys(this.SUBCLASSES)}static get SUBCLASSES(){return{score:d,tagcount:p,uploaderid:g,rating:f,status:m,has:w,is:x,vote:v}}static create(t,e){const s=this.SUBCLASSES[t];return void 0===s?null:new s(e)}}class d extends o{match(e){const s=t.parse(this.value);return null!==s&&s.includes(e.score)}}class p extends o{match(e){const s=t.parse(this.value);return null!==s&&s.includes(e.tags.length)}}class g extends o{match(e){const s=t.parse(this.value);return null!==s&&s.includes(e.uploaderId)}}class f extends o{match(t){return this.value.split(",").map((t=>t.slice(0,1))).includes(t.rating)}}class m extends o{match(t){switch(this.value){case"pending":return t.isPending;case"flagged":return t.isFlagged;case"deleted":return t.isDeleted;case"banned":return t.isBanned;case"active":return t.isActive;default:return!1}}}class w extends o{match(t){switch(this.value){case"parent":return t.hasParent;case"child":case"children":return t.hasChildren;default:return!1}}}class x extends o{match(t){switch(this.value){case"parent":return new w("children").match(t);case"child":return new w("parent").match(t);case"pending":case"flagged":case"deleted":case"banned":case"active":return new m(this.value).match(t);case"general":case"sensitive":case"questionable":case"explicit":return new f(this.value).match(t);case"safe":return new f("s").match(t);case"nsfw":return new f("q,e").match(t);case"sfw":return new f("g,s").match(t);default:return!1}}}class v extends o{match(e){if(null===e.vote)return!1;const s=t.parse(this.value);return null!==s&&s.includes(e.vote)}}class S{post;constructor(t){this.post=t}get flags(){return this.post.dataset.flags.split(" ")}get tags(){return this.post.dataset.tags.split(" ")}get score(){return Number.parseInt(this.post.dataset.score)}get rating(){return this.post.dataset.rating}get uploaderId(){return Number.parseInt(this.post.dataset.uploaderId)}get isActive(){return!(this.isPending||this.isDeleted||this.isFlagged)}get isPending(){return this.flags.includes("pending")}get isFlagged(){return this.flags.includes("flagged")}get isDeleted(){return this.flags.includes("deleted")}get isBanned(){return this.flags.includes("banned")}get hasParent(){return this.post.classList.contains("post-status-has-parent")}get hasChildren(){return this.post.classList.contains("post-status-has-children")}get vote(){const t=document.querySelector("#post-info-score, .post-preview-score");return null===t?null:t.querySelector(".post-upvote-link.post-unvote-link")?1:t.querySelector(".post-downvote-link.post-unvote-link")?-1:0}}class b{simplify(){return this}}class E extends b{match(t){return!0}}class k extends b{match(t){return!1}}class C extends b{left;right;constructor(t,e){super(),this.left=t,this.right=e}match(t){return this.left.match(t)&&this.right.match(t)}simplify(){const t=this.left.simplify(),e=this.right.simplify();return t instanceof k||e instanceof k?new k:t instanceof E?e:e instanceof E?t:t instanceof C?new C(t.left,new C(t.right,e).simplify()):new C(t,e)}}class y extends b{left;right;constructor(t,e){super(),this.left=t,this.right=e}match(t){return this.left.match(t)||this.right.match(t)}simplify(){const t=this.left.simplify(),e=this.right.simplify();return t instanceof E||e instanceof E?new E:t instanceof k?e:e instanceof k?t:t instanceof y?new y(t.left,new y(t.right,e).simplify()):new y(t,e)}}class L extends b{node;constructor(t){super(),this.node=t}match(t){return!this.node.match(t)}simplify(){const t=this.node.simplify();return t instanceof E?new k:t instanceof k?new E:t instanceof L?t.node:new L(t)}}class R extends b{tag;constructor(t){super(),this.tag=t,this.tag=this.tag.toLowerCase()}match(t){return t.tags.map((t=>t.toLowerCase())).includes(this.tag.toLowerCase())}}class A extends b{wildcard;regex;constructor(t){super(),this.wildcard=t;const e=this.wildcard.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d").replace(/\\\*/g,"[\\s\\S]*");this.regex=RegExp(`^${e}$`,"i")}match(t){return t.tags.some((t=>null!==this.regex.exec(t)))}}class B extends b{name;value;constructor(t,e){super(),this.name=t,this.value=e,this.name=this.name.toLowerCase()}match(t){const e=o.create(this.name,this.value);return null!==e&&e.match(t)}}class P{source;match;captures;head;last;constructor(t){this.source=t.toString(),this.reset()}scan(t){const e=t.exec(this.getRemainder());return 0===e?.index?this.setState(e,{head:this.head+e[0].length,last:this.head}):this.setState([])}scanUntil(t){const e=t.exec(this.getRemainder());return e?(this.setState(e,{head:this.head+e.index+e[0].length,last:this.head}),this.source.slice(this.last,this.head)):this.setState([])}scanChar(){return this.scan(/[\s\S]/)}skip(t){return null===this.scan(t)?null:this.match.length}skipUntil(t){return null===this.scanUntil(t)?null:this.head-this.last}check(t){const e=t.exec(this.getRemainder());return null===e||0!==e.index?this.setState([]):this.setState(e)}checkUntil(t){const e=t.exec(this.getRemainder());return null===e?this.setState([]):(this.setState(e),this.source.slice(this.head,this.head+e.index+e[0].length))}peek(t=1){return this.source.substring(this.head,this.head+t)}getSource(){return this.source}getRemainder(){return this.source.slice(this.head)}getPosition(){return this.head}hasTerminated(){return this.head===this.source.length}getPreMatch(){return null===this.match?null:this.source.slice(0,this.head-this.match.length)}getMatch(){return this.match}getPostMatch(){return null===this.match?null:this.source.slice(this.head)}getCapture(t){const e=this.captures[t];return void 0===e?null:e}reset(){this.setState([],{head:0,last:0})}terminate(){this.setState([],{head:this.source.length,last:this.head})}concat(t){this.source+=t}unscan(){const t=this.match;return null!==t&&this.setState([],{head:this.last,last:0}),t}setPosition(t){this.setState([],{head:t,last:this.head})}setState(t,{head:e,last:s}={}){return void 0!==e&&(e<0&&(e=0),this.head=e),void 0!==s&&(this.last=s),this.captures=t.slice(1),this.match=(()=>{const e=t[0];return void 0===e?null:e})(),this.match}}class D{scanner;state;constructor(t,e){this.state=e,this.scanner=new P(t)}eos(){return this.scanner.hasTerminated()}accept(t){return this.scanner.scan(t)}rewind(t=1){this.scanner.setPosition(this.scanner.getPosition()-t)}backtrack(t){if(this.eos())return null;const e=this.scanner.getPosition(),s=structuredClone(this.state),n=t();return null===n&&(this.scanner.setPosition(e),this.state=s),n}zeroOrMore(t){const e=[];for(;;){const s=this.backtrack(t);if(null===s)break;e.push(s)}return e}oneOf(t){for(const e of t){const t=this.backtrack(e);if(null!==t)return t}return null}}class U{ast;constructor(t){this.ast=t}}class N extends U{}class M extends U{}class G extends U{}class T{static PERMITTED_UNBALANCED_TAGS=[":)",":(",";)",";(",">:)",">:("];parser;metatagRegex;constructor(t,e){this.parser=new D(t,0),this.metatagRegex=RegExp(`(${e.join("|")}):`,"i")}static parse(t,e=[]){return new T(t,e).parse()}parse(){let t=this.root();return this.parser.eos()||(t=null),0!==this.parser.state&&(t=null),null===t?new k:t.simplify()}root(){const t=this.parser.zeroOrMore(this.orClause.bind(this));this.space();let e=new E;for(const s of t)e=new C(e,s);return e}orClause(){const t=this.andClause();if(null===t)return null;if(this.space(),null!==this.parser.accept(/or +/i)){const e=this.orClause();return null===e?null:new y(t,e)}return t}andClause(){const t=this.factorList();if(null===t)return null;if(this.space(),null!==this.parser.accept(/and +/i)){const e=this.andClause();return null===e?null:new C(t,e)}return t}factorList(){const t=this.parser.zeroOrMore(this.factor.bind(this));if(0===t.length)return null;let e=new E,s=new k;for(const n of t){let t=n.ast;n instanceof M&&(t=new L(t)),n instanceof G?s=new y(s,t):e=new C(e,t)}return s instanceof y&&(e=new C(e,s)),e}factor(){let t;this.space(),t=null!==this.parser.accept(/-/)?M:null!==this.parser.accept(/~/)?G:N;const e=this.expr();return null===e?null:new t(e)}expr(){if(this.space(),this.parser.accept(/\(/)){++this.parser.state;const t=this.orClause();return null===t||null===this.parser.accept(/\)/)?null:(--this.parser.state,t)}return this.term()}term(){return this.parser.oneOf([this.tag.bind(this),this.metatag.bind(this),this.wildcard.bind(this)])}metatag(){let t=this.parser.accept(this.metatagRegex);if(null===t)return null;t=t.slice(0,-1);const e=this.quotedString();return null===e?null:new B(t,e)}quotedString(){if(null!==this.parser.accept(/"/)){const t=this.parser.accept(/([^"\\]|\\")*/).replaceAll(/\\"/g,'"');return null===this.parser.accept(/"/)?null:t}if(null!==this.parser.accept(/'/)){const t=this.parser.accept(/([^'\\]|\\')*/).replaceAll(/\\'/g,"'");return null===this.parser.accept(/'/)?null:t}return this.string(/[^ ]*/)}wildcard(){const t=this.string(/(?=[^ ]*\*)[^ )~-][^ ]*/,!0);return null===t||0===this.metatagRegex.exec(t)?.index?null:(this.space(),new A(t))}tag(){const t=this.string(/[^ )~-][^ ]*/,!0);return null===t||["and","or"].includes(t.toLowerCase())||t.includes("*")||0===this.metatagRegex.exec(t)?.index?null:(this.space(),new R(t))}string(t,e=!1){let s=this.parser.accept(t);if(null===s)return null;let n=this.parser.state;for(;n-- >0&&s.endsWith(")")&&(!e||!T.hasBalancedParens(s)&&!T.PERMITTED_UNBALANCED_TAGS.includes(s));)s=s.slice(0,-1),this.parser.rewind();return s}space(){return this.parser.accept(/ */)}static hasBalancedParens(t,e="(",s=")"){let n=0;for(const r of t)if(r===e)++n;else if(r===s&&--n<0)return!1;return 0===n}}$((()=>{if(0===$("#blacklist-box").length)return;Danbooru.Blacklist.post_match=(t,e)=>!e.disabled&&e.ast.match(new S(t));const t=Danbooru.Blacklist.parse_entry;Danbooru.Blacklist.parse_entry=e=>{const s=t(e);return s.ast=T.parse(e,o.NAMES),s},Danbooru.Blacklist.entries=[],$("#blacklist-list").empty(),$("#blacklist-box").hide(),Danbooru.Blacklist.initialize_all(),new MutationObserver(((t,e)=>{for(const e of t)for(const t of e.addedNodes)t instanceof HTMLElement&&t.classList.contains("post-votes")&&(Danbooru.Blacklist.apply()>0?Danbooru.Blacklist.update_sidebar():$("#blacklist-box").hide())})).observe(document.body,{childList:!0,subtree:!0})}))})();
