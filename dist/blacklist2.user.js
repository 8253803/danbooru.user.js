// ==UserScript==
// @name Danbooru - Blacklist2
// @version 20250619163621
// @author hdk5
// @supportURL https://github.com/hdk5/danbooru.user.js/issues
// @match *://*.donmai.us/*
// @downloadURL https://github.com/hdk5/danbooru.user.js/raw/master/dist/blacklist2.user.js
// @grant none
// @homepageURL https://github.com/hdk5/danbooru.user.js
// @namespace https://github.com/hdk5/danbooru.user.js
// @updateURL https://github.com/hdk5/danbooru.user.js/raw/master/dist/blacklist2.meta.js
// ==/UserScript==

(()=>{"use strict";function t(t,e,s){return(e=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var s=e.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}class e{static get SUBCLASSES(){return[s,n,r,c,a,l,i,h,u,o]}static parse(t){for(const e of this.SUBCLASSES){const s=e.parse(t);if(null!==s)return s}return null}static parseValue(t){return Number.parseInt(t)}}class s extends e{constructor(t){super(),this.ranges=t}static parse(t){if(null===/[, ]/.exec(t))return null;const s=[];for(const n of t.split(/[, ]+/)){const t=e.parse(n);if(null===t)return null;s.push(t)}return new this(s)}includes(t){return this.ranges.some(e=>e.includes(t))}}class n extends e{constructor(t,e){super(),this.start=t,this.end=e}static parse(t){const e=this.REGEX.exec(t);return null===e?null:new this(this.parseValue(e[1]),this.parseValue(e[2]))}includes(t){return this.start<=t&&t<this.end}}t(n,"REGEX",/^(.+?)\.\.\.(.+)/);class r extends n{includes(t){return this.start<=t&&t<=this.end}}t(r,"REGEX",/^(.+?)\.\.(.+)/);class i extends e{constructor(t){super(),this.value=t}static parse(t){const e=this.REGEX.exec(t);return null===e?null:new this(this.parseValue(e.filter(Boolean)[1]))}includes(t){return t>this.value}}t(i,"REGEX",/^>(.+)/);class a extends i{includes(t){return t<this.value}}t(a,"REGEX",/^<(.+)/);class l extends i{includes(t){return t>=this.value}}t(l,"REGEX",/^(?:>=(.+)|(.+)\.\.$)/);class c extends i{includes(t){return t<=this.value}}t(c,"REGEX",/^(?:<=(.+)|\.\.(.+))/);class u extends e{static parse(t){return t!==this.VALUE?null:new this}includes(t){return Number.isNaN(t)}}t(u,"VALUE","none");class h extends u{includes(t){return!super.includes(t)}}t(h,"VALUE","any");class o extends e{constructor(t){super(),this.value=t}static parse(t){return new this(this.parseValue(t))}includes(t){return t===this.value}}class d{constructor(t){this.value=t}static get NAMES(){return Object.keys(this.SUBCLASSES)}static get SUBCLASSES(){return{score:p,tagcount:g,uploaderid:f,rating:m,status:v,has:w,is:x,vote:S}}static create(t,e){const s=this.SUBCLASSES[t];return void 0===s?null:new s(e)}}class p extends d{match(t){const s=e.parse(this.value);return null!==s&&s.includes(t.score)}}class g extends d{match(t){const s=e.parse(this.value);return null!==s&&s.includes(t.tags.length)}}class f extends d{match(t){const s=e.parse(this.value);return null!==s&&s.includes(t.uploaderId)}}class m extends d{match(t){return this.value.split(",").map(t=>t.slice(0,1)).includes(t.rating)}}class v extends d{match(t){switch(this.value){case"pending":return t.isPending;case"flagged":return t.isFlagged;case"deleted":return t.isDeleted;case"banned":return t.isBanned;case"active":return t.isActive;default:return!1}}}class w extends d{match(t){switch(this.value){case"parent":return t.hasParent;case"child":case"children":return t.hasChildren;default:return!1}}}class x extends d{match(t){switch(this.value){case"parent":return new w("children").match(t);case"child":return new w("parent").match(t);case"pending":case"flagged":case"deleted":case"banned":case"active":return new v(this.value).match(t);case"general":case"sensitive":case"questionable":case"explicit":return new m(this.value).match(t);case"safe":return new m("s").match(t);case"nsfw":return new m("q,e").match(t);case"sfw":return new m("g,s").match(t);default:return!1}}}class S extends d{match(t){if(null===t.vote)return!1;const s=e.parse(this.value);return null!==s&&s.includes(t.vote)}}class b{constructor(t){this.post=t}get flags(){return this.post.dataset.flags.split(" ")}get tags(){return this.post.dataset.tags.split(" ")}get score(){return Number.parseInt(this.post.dataset.score)}get rating(){return this.post.dataset.rating}get uploaderId(){return Number.parseInt(this.post.dataset.uploaderId)}get isActive(){return!(this.isPending||this.isDeleted||this.isFlagged)}get isPending(){return this.flags.includes("pending")}get isFlagged(){return this.flags.includes("flagged")}get isDeleted(){return this.flags.includes("deleted")}get isBanned(){return this.flags.includes("banned")}get hasParent(){return this.post.classList.contains("post-status-has-parent")}get hasChildren(){return this.post.classList.contains("post-status-has-children")}get vote(){var t;const e=null!==(t=this.post.querySelector(".post-preview-score"))&&void 0!==t?t:document.querySelector("#post-info-score");return null===e?null:e.querySelector(".post-upvote-link.post-unvote-link")?1:e.querySelector(".post-downvote-link.post-unvote-link")?-1:0}}class E{simplify(){return this}}class y extends E{match(t){return!0}}class C extends E{match(t){return!1}}class P extends E{constructor(t,e){super(),this.left=t,this.right=e}match(t){return this.left.match(t)&&this.right.match(t)}simplify(){const t=this.left.simplify(),e=this.right.simplify();return t instanceof C||e instanceof C?new C:t instanceof y?e:e instanceof y?t:t instanceof P?new P(t.left,new P(t.right,e).simplify()):new P(t,e)}}class R extends E{constructor(t,e){super(),this.left=t,this.right=e}match(t){return this.left.match(t)||this.right.match(t)}simplify(){const t=this.left.simplify(),e=this.right.simplify();return t instanceof y||e instanceof y?new y:t instanceof C?e:e instanceof C?t:t instanceof R?new R(t.left,new R(t.right,e).simplify()):new R(t,e)}}class k extends E{constructor(t){super(),this.node=t}match(t){return!this.node.match(t)}simplify(){const t=this.node.simplify();return t instanceof y?new C:t instanceof C?new y:t instanceof k?t.node:new k(t)}}class A extends E{constructor(t){super(),this.tag=t,this.tag=this.tag.toLowerCase()}match(t){return t.tags.map(t=>t.toLowerCase()).includes(this.tag.toLowerCase())}}class L extends E{constructor(t){super(),this.wildcard=t;const e=this.wildcard.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d").replace(/\\\*/g,"[\\s\\S]*");this.regex=new RegExp("^".concat(e,"$"),"i")}match(t){return t.tags.some(t=>null!==this.regex.exec(t))}}class B extends E{constructor(t,e){super(),this.name=t,this.value=e,this.name=this.name.toLowerCase()}match(t){const e=d.create(this.name,this.value);return null!==e&&e.match(t)}}class U{constructor(t){this.source=t.toString(),this.reset()}scan(t){const e=t.exec(this.getRemainder());return 0===(null==e?void 0:e.index)?this.setState(e,{head:this.head+e[0].length,last:this.head}):this.setState([])}scanUntil(t){const e=t.exec(this.getRemainder());return e?(this.setState(e,{head:this.head+e.index+e[0].length,last:this.head}),this.source.slice(this.last,this.head)):this.setState([])}scanChar(){return this.scan(/[\s\S]/)}skip(t){return null===this.scan(t)?null:this.match.length}skipUntil(t){return null===this.scanUntil(t)?null:this.head-this.last}check(t){const e=t.exec(this.getRemainder());return null===e||0!==e.index?this.setState([]):this.setState(e)}checkUntil(t){const e=t.exec(this.getRemainder());return null===e?this.setState([]):(this.setState(e),this.source.slice(this.head,this.head+e.index+e[0].length))}peek(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.source.substring(this.head,this.head+t)}getSource(){return this.source}getRemainder(){return this.source.slice(this.head)}getPosition(){return this.head}hasTerminated(){return this.head===this.source.length}getPreMatch(){return null===this.match?null:this.source.slice(0,this.head-this.match.length)}getMatch(){return this.match}getPostMatch(){return null===this.match?null:this.source.slice(this.head)}getCapture(t){const e=this.captures[t];return void 0===e?null:e}reset(){this.setState([],{head:0,last:0})}terminate(){this.setState([],{head:this.source.length,last:this.head})}concat(t){this.source+=t}unscan(){const t=this.match;return null!==t&&this.setState([],{head:this.last,last:0}),t}setPosition(t){this.setState([],{head:t,last:this.head})}setState(t){let{head:e,last:s}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return void 0!==e&&(e<0&&(e=0),this.head=e),void 0!==s&&(this.last=s),this.captures=t.slice(1),this.match=(()=>{const e=t[0];return void 0===e?null:e})(),this.match}}class N{constructor(t,e){this.state=e,this.scanner=new U(t)}eos(){return this.scanner.hasTerminated()}accept(t){return this.scanner.scan(t)}rewind(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.scanner.setPosition(this.scanner.getPosition()-t)}backtrack(t){if(this.eos())return null;const e=this.scanner.getPosition(),s=structuredClone(this.state),n=t();return null===n&&(this.scanner.setPosition(e),this.state=s),n}zeroOrMore(t){const e=[];for(;;){const s=this.backtrack(t);if(null===s)break;e.push(s)}return e}oneOf(t){for(const e of t){const t=this.backtrack(e);if(null!==t)return t}return null}}class D{constructor(t){this.ast=t}}class G extends D{}class M extends D{}class T extends D{}class q{constructor(t,e){this.parser=new N(t,0),this.metatagRegex=new RegExp("(".concat(e.join("|"),"):"),"i")}static parse(t){return new q(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).parse()}parse(){let t=this.root();return this.parser.eos()||(t=null),0!==this.parser.state&&(t=null),null===t?new C:t.simplify()}root(){const t=this.parser.zeroOrMore(this.orClause.bind(this));this.space();let e=new y;for(const s of t)e=new P(e,s);return e}orClause(){const t=this.andClause();if(null===t)return null;if(this.space(),null!==this.parser.accept(/or +/i)){const e=this.orClause();return null===e?null:new R(t,e)}return t}andClause(){const t=this.factorList();if(null===t)return null;if(this.space(),null!==this.parser.accept(/and +/i)){const e=this.andClause();return null===e?null:new P(t,e)}return t}factorList(){const t=this.parser.zeroOrMore(this.factor.bind(this));if(0===t.length)return null;let e=new y,s=new C;for(const n of t){let t=n.ast;n instanceof M&&(t=new k(t)),n instanceof T?s=new R(s,t):e=new P(e,t)}return s instanceof R&&(e=new P(e,s)),e}factor(){let t;this.space(),t=null!==this.parser.accept(/-/)?M:null!==this.parser.accept(/~/)?T:G;const e=this.expr();return null===e?null:new t(e)}expr(){if(this.space(),null!==this.parser.accept(/\(/)){++this.parser.state;const t=this.orClause();return null===t||null===this.parser.accept(/\)/)?null:(--this.parser.state,t)}return this.term()}term(){return this.parser.oneOf([this.tag.bind(this),this.metatag.bind(this),this.wildcard.bind(this)])}metatag(){let t=this.parser.accept(this.metatagRegex);if(null===t)return null;t=t.slice(0,-1);const e=this.quotedString();return null===e?null:new B(t,e)}quotedString(){if(null!==this.parser.accept(/"/)){const t=this.parser.accept(/([^"\\]|\\")*/).replaceAll(/\\"/g,'"');return null===this.parser.accept(/"/)?null:t}if(null!==this.parser.accept(/'/)){const t=this.parser.accept(/([^'\\]|\\')*/).replaceAll(/\\'/g,"'");return null===this.parser.accept(/'/)?null:t}return this.string(/[^ ]*/)}wildcard(){var t;const e=this.string(/(?=[^ ]*\*)[^ )~-][^ ]*/,!0);return null===e||0===(null===(t=this.metatagRegex.exec(e))||void 0===t?void 0:t.index)?null:(this.space(),new L(e))}tag(){var t;const e=this.string(/[^ )~-][^ ]*/,!0);return null===e||["and","or"].includes(e.toLowerCase())||e.includes("*")||0===(null===(t=this.metatagRegex.exec(e))||void 0===t?void 0:t.index)?null:(this.space(),new A(e))}string(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],s=this.parser.accept(t);if(null===s)return null;let n=this.parser.state;for(;n-- >0&&s.endsWith(")")&&(!e||!q.hasBalancedParens(s)&&!q.PERMITTED_UNBALANCED_TAGS.includes(s));)s=s.slice(0,-1),this.parser.rewind();return s}space(){return this.parser.accept(/ */)}static hasBalancedParens(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"(",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:")",n=0;for(const r of t)if(r===e)++n;else if(r===s&&--n<0)return!1;return 0===n}}var j,I,O;j=q,O=[":)",":(",";)",";(",">:)",">:("],(I=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var s=e.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(I="PERMITTED_UNBALANCED_TAGS"))in j?Object.defineProperty(j,I,{value:O,enumerable:!0,configurable:!0,writable:!0}):j[I]=O;class V extends Danbooru.Blacklist{initialize(t){this.rules=t.map(t=>new X(this,t)),this.posts=$(".post-preview, .image-container, #c-comments .post, .mod-queue-preview.post-preview").toArray().map(t=>new _(t,this)),this.apply(),this.cleanupStorage()}}class X extends Danbooru.Blacklist.Rule{constructor(t,e){super(t,e),this.ast=q.parse(e,d.NAMES)}match(t){return this.ast.match(t.x_post)}}class _ extends Danbooru.Blacklist.Post{constructor(t,e){super(t,e),this.x_post=new b(t)}}Danbooru.Blacklist=V})();