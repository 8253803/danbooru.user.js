// ==UserScript==
// @name Danbooru - Blacklist2
// @description Advanced blacklist rule grammar for Danbooru.
// @version 1.0.0
// @author hdk5
// @supportURL https://github.com/hdk5/danbooru-blacklist2/issues
// @match *://*.donmai.us/*
// @grant none
// @homepageURL https://github.com/hdk5/danbooru-blacklist2
// @installURL https://github.com/hdk5/danbooru-blacklist2/raw/master/dist/danbooru-blacklist2.user.js
// @namespace danbooru.hdk5
// @updateURL https://github.com/hdk5/danbooru-blacklist2/raw/master/dist/danbooru-blacklist2.user.js
// ==/UserScript==

(()=>{"use strict";var t={302:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ASTMetatag=e.ASTWildcard=e.ASTTag=e.ASTNot=e.ASTOr=e.ASTAnd=e.ASTNone=e.ASTAll=e.AST=void 0;class s{}e.AST=s,e.ASTAll=class extends s{match(t){return!0}},e.ASTNone=class extends s{match(t){return!1}},e.ASTAnd=class extends s{left;right;constructor(t,e){super(),this.left=t,this.right=e}match(t){return this.left.match(t)&&this.right.match(t)}},e.ASTOr=class extends s{left;right;constructor(t,e){super(),this.left=t,this.right=e}match(t){return this.left.match(t)||this.right.match(t)}},e.ASTNot=class extends s{node;constructor(t){super(),this.node=t}match(t){return!this.node.match(t)}},e.ASTTag=class extends s{tag;constructor(t){super(),this.tag=t}match(t){return t.tags.includes(this.tag)}},e.ASTWildcard=class extends s{wildcard;regex;constructor(t){super(),this.wildcard=t,this.regex=RegExp(`^${t.replaceAll("*",".*")}$`,"i")}match(t){return t.tags.some((t=>null!==this.regex.exec(t)))}},e.ASTMetatag=class extends s{name;value;constructor(t,e){super(),this.name=t,this.value=e}match(t){if("rating"===this.name)return t.rating===this.value.slice(0,1);if("score"===this.name){if(this.value.startsWith(">")){const e=parseInt(this.value.slice(1));return t.score>e}if(this.value.startsWith("<")){const e=parseInt(this.value.slice(1));return t.score<e}const e=parseInt(this.value);return t.score===e}if("uploaderid"===this.name){const e=parseInt(this.value);return t.uploaderId===e}return"is"===this.name?"pending"===this.value?t.isPending:"flagged"===this.value?t.isFlagged:"deleted"===this.value?t.isDeleted:"banned"===this.value&&t.isBanned:"has"===this.name&&("parent"===this.value?t.hasParent:"children"===this.value&&t.hasChildren)}}},891:(t,e)=>{var s;Object.defineProperty(e,"__esModule",{value:!0}),e.Metatag=void 0,function(t){t.rating="rating",t.score="score",t.uploaderid="uploaderid",t.is="is",t.has="has"}(s||(e.Metatag=s={}))},776:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Post=void 0;class s{tags;score;rating;uploaderId;isPending;isFlagged;isDeleted;isBanned;hasParent;hasChildren;constructor(t,e,s,r,a,n,i,l,h,c){this.tags=t,this.score=e,this.rating=s,this.uploaderId=r,this.isPending=a,this.isFlagged=n,this.isDeleted=i,this.isBanned=l,this.hasParent=h,this.hasChildren=c}static fromElement(t){const e=t.dataset.tags.split(" "),r=parseInt(t.dataset.score),a=t.dataset.rating,n=parseInt(t.dataset.uploaderId),i=t.dataset.flags.split(" "),l=i.includes("pending"),h=i.includes("flagged"),c=i.includes("deleted"),u=i.includes("banned"),o=t.classList.contains("post-status-has-parent"),d=t.classList.contains("post-status-has-children");return new s(e,r,a,n,l,h,c,u,o,d)}}e.Post=s},125:(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.QueryParser=void 0;const r=s(302),a=s(708),n=s(992);class i{parser;metatagRegex;constructor(t,e){this.parser=new a.StringParser(t,0),this.metatagRegex=RegExp(`(${e.join("|")}):`,"i")}static parse(t,e=[]){return new i(t,e).parse()}parse(){let t=this.root();return this.parser.eos()||(t=null),0!==this.parser.state&&(t=null),null===t?new r.ASTNone:t}root(){let[t,...e]=this.parser.zeroOrMore(this.orClause.bind(this));if(this.space(),void 0===t)return new r.ASTAll;for(const s of e)t=new r.ASTAnd(t,s);return t}orClause(){const t=this.andClause();if(null===t)return null;if(this.space(),null!==this.parser.accept(/or +/i)){const e=this.orClause();return null===e?null:new r.ASTOr(t,e)}return t}andClause(){const t=this.factorList();if(null===t)return null;if(this.space(),null!==this.parser.accept(/and +/i)){const e=this.andClause();return null===e?null:new r.ASTAnd(t,e)}return t}factorList(){let[t,...e]=this.parser.zeroOrMore(this.factor.bind(this));if(void 0===t)return null;for(const s of e)t=new r.ASTAnd(t,s);return t}factor(){if(this.space(),null!==this.parser.accept(/-/)){const t=this.expr();return null===t?null:new r.ASTNot(t)}return null!==this.parser.accept(/~/)?null:this.expr()}expr(){if(this.space(),this.parser.accept(/\(/)){++this.parser.state;const t=this.orClause();return null===t||null===this.parser.expect(/\)/)?null:(--this.parser.state,t)}return this.term()}term(){return this.parser.oneOf([this.tag.bind(this),this.metatag.bind(this),this.wildcard.bind(this)])}metatag(){let t=this.parser.expect(this.metatagRegex);if(null===t)return null;t=t.slice(0,-1);const e=this.quotedString();return null===e?null:new r.ASTMetatag(t,e)}quotedString(){if(null!==this.parser.accept(/"/)){const t=this.parser.accept(/([^"\\]|\\")*/).replaceAll(/\\"/,'"');return null===this.parser.expect(/"/)?null:t}if(null!==this.parser.accept(/'/)){const t=this.parser.accept(/([^'\\]|\\')*/).replaceAll(/\\'/,'"');return null===this.parser.expect(/'/)?null:t}return this.string(/[^ ]*/)}wildcard(){const t=this.string(/(?=[^ ]*\*)[^ )~-][^ ]*/,!0);return null===t||0===this.metatagRegex.exec(t)?.index?null:(this.space(),new r.ASTWildcard(t))}tag(){const t=this.string(/[^ )~-][^ ]*/,!0);return null===t||["and","or"].includes(t.toLowerCase())||t.includes("*")||0===this.metatagRegex.exec(t)?.index?null:(this.space(),new r.ASTTag(t))}string(t,e=!1){let s=this.parser.expect(t);if(null===s)return null;let r=this.parser.state;for(;r-- >0&&s.endsWith(")")&&(!e||!i.hasBalancedParens(s)&&!n.Tag.PERMITTED_UNBALANCED_TAGS.includes(s));)s=s.slice(0,-1),this.parser.rewind();return s}space(){return this.parser.expect(/ */)}static hasBalancedParens(t,e="(",s=")"){let r=0;for(const a of t)if(a===e)++r;else if(a===s&&--r<0)return!1;return 0===r}}e.QueryParser=i},708:(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.StringParser=void 0;const r=s(998);e.StringParser=class{scanner;state;constructor(t,e){this.state=e,this.scanner=new r.StringScanner(t)}rest(){return this.scanner.getRemainder()}eos(){return this.scanner.hasTerminated()}accept(t){return this.scanner.scan(t)}skip(t){return null!==this.accept(t)}expect(t){return this.accept(t)}rewind(t=1){this.scanner.setPosition(this.scanner.getPosition()-t)}backtrack(t){if(this.eos())return null;const e=this.scanner.getPosition(),s=window.structuredClone(this.state),r=t();return null===r&&(this.scanner.setPosition(e),this.state=s),r}zeroOrMore(t){const e=[];for(;;){const s=this.backtrack(t);if(null===s)break;e.push(s)}return e}oneOf(t){for(const e of t){const t=this.backtrack(e);if(null!==t)return t}return null}}},998:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.StringScanner=void 0,e.StringScanner=class{source;match;captures;head;last;constructor(t){this.source=t.toString(),this.reset()}scan(t){const e=t.exec(this.getRemainder());return 0===e?.index?this.setState(e,{head:this.head+e[0].length,last:this.head}):this.setState([])}scanUntil(t){const e=t.exec(this.getRemainder());return e?(this.setState(e,{head:this.head+e.index+e[0].length,last:this.head}),this.source.slice(this.last,this.head)):this.setState([])}scanChar(){return this.scan(/[\s\S]/)}skip(t){return null===this.scan(t)?null:this.match.length}skipUntil(t){return null===this.scanUntil(t)?null:this.head-this.last}check(t){const e=t.exec(this.getRemainder());return null===e||0!==e.index?this.setState([]):this.setState(e)}checkUntil(t){const e=t.exec(this.getRemainder());return null===e?this.setState([]):(this.setState(e),this.source.slice(this.head,this.head+e.index+e[0].length))}peek(t=1){return this.source.substring(this.head,this.head+t)}getSource(){return this.source}getRemainder(){return this.source.slice(this.head)}getPosition(){return this.head}hasTerminated(){return this.head===this.source.length}getPreMatch(){return null===this.match?null:this.source.slice(0,this.head-this.match.length)}getMatch(){return this.match}getPostMatch(){return null===this.match?null:this.source.slice(this.head)}getCapture(t){const e=this.captures[t];return void 0===e?null:e}reset(){this.setState([],{head:0,last:0})}terminate(){this.setState([],{head:this.source.length,last:this.head})}concat(t){this.source+=t}unscan(){const t=this.match;return void 0!==t&&this.setState([],{head:this.last,last:0}),t}setPosition(t){this.setState([],{head:t,last:this.head})}setState(t,{head:e,last:s}={}){return void 0!==e&&(e<0&&(e=0),this.head=e),void 0!==s&&(this.last=s),this.captures=t.slice(1),this.match=(()=>{const e=t[0];return void 0===e?null:e})(),this.match}}},992:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Tag=void 0,e.Tag=class{static PERMITTED_UNBALANCED_TAGS=[":)",":(",";)",";(",">:)",">:("]}}},e={};function s(r){var a=e[r];if(void 0!==a)return a.exports;var n=e[r]={exports:{}};return t[r](n,n.exports,s),n.exports}(()=>{const t=s(891),e=s(776),r=s(125);$((()=>{if(0===$("#blacklist-box").length)return;Danbooru.Blacklist.post_match=(t,s)=>!s.disabled&&s.ast.match(e.Post.fromElement(t));const s=Danbooru.Blacklist.parse_entry;Danbooru.Blacklist.parse_entry=e=>{const a=s(e);return a.ast=r.QueryParser.parse(e,Object.values(t.Metatag)),a},Danbooru.Blacklist.entries=[],$("#blacklist-list").empty(),$("#blacklist-box").hide(),Danbooru.Blacklist.initialize_all()}))})()})();
//# sourceMappingURL=danbooru-blacklist2.user.js.map