// ==UserScript==
// @name Danbooru - Blacklist2
// @description Advanced blacklist rule grammar for Danbooru.
// @version 1.3.0
// @author hdk5
// @supportURL https://github.com/hdk5/danbooru-blacklist2/issues
// @match *://*.donmai.us/*
// @grant none
// @homepageURL https://github.com/hdk5/danbooru-blacklist2
// @installURL https://github.com/hdk5/danbooru-blacklist2/raw/master/dist/danbooru-blacklist2.user.js
// @namespace danbooru.hdk5
// @updateURL https://github.com/hdk5/danbooru-blacklist2/raw/master/dist/danbooru-blacklist2.user.js
// ==/UserScript==

(()=>{"use strict";var t={302:(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ASTMetatag=e.ASTWildcard=e.ASTTag=e.ASTNot=e.ASTOr=e.ASTAnd=e.ASTNone=e.ASTAll=e.AST=void 0;const n=s(666);class r{simplify(){return this}}e.AST=r;class a extends r{match(t){return!0}}e.ASTAll=a;class i extends r{match(t){return!1}}e.ASTNone=i;class l extends r{left;right;constructor(t,e){super(),this.left=t,this.right=e}match(t){return this.left.match(t)&&this.right.match(t)}simplify(){const t=this.left.simplify(),e=this.right.simplify();return t instanceof i||e instanceof i?new i:t instanceof a?e:e instanceof a?t:t instanceof l?new l(t.left,new l(t.right,e).simplify()):new l(t,e)}}e.ASTAnd=l;class c extends r{left;right;constructor(t,e){super(),this.left=t,this.right=e}match(t){return this.left.match(t)||this.right.match(t)}simplify(){const t=this.left.simplify(),e=this.right.simplify();return t instanceof a||e instanceof a?new a:t instanceof i?e:e instanceof i?t:t instanceof c?new c(t.left,new c(t.right,e).simplify()):new c(t,e)}}e.ASTOr=c;class h extends r{node;constructor(t){super(),this.node=t}match(t){return!this.node.match(t)}simplify(){const t=this.node.simplify();return t instanceof a?new i:t instanceof i?new a:t instanceof h?t.node:new h(t)}}e.ASTNot=h,e.ASTTag=class extends r{tag;constructor(t){super(),this.tag=t,this.tag=this.tag.toLowerCase()}match(t){return t.tags.map((t=>t.toLowerCase())).includes(this.tag.toLowerCase())}},e.ASTWildcard=class extends r{wildcard;regex;constructor(t){super(),this.wildcard=t;const e=this.wildcard.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d").replace(/\\\*/g,"[\\s\\S]*");this.regex=RegExp(`^${e}$`,"i")}match(t){return t.tags.some((t=>null!==this.regex.exec(t)))}},e.ASTMetatag=class extends r{name;value;constructor(t,e){super(),this.name=t,this.value=e,this.name=this.name.toLowerCase()}match(t){const e=n.Metatag.create(this.name,this.value);return null!==e&&e.match(t)}}},666:(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Metatag=void 0;const n=s(621);class r{value;constructor(t){this.value=t}static get NAMES(){return Object.keys(this.SUBCLASSES)}static get SUBCLASSES(){return{rating:a,score:i,tagcount:l,uploaderid:c,is:h,has:u}}static create(t,e){const s=this.SUBCLASSES[t];return void 0===s?null:new s(e)}}e.Metatag=r;class a extends r{match(t){return this.value.split(",").map((t=>t.slice(0,1))).includes(t.rating)}}class i extends r{match(t){const e=n.Range.parse(this.value);return null!==e&&e.includes(t.score)}}class l extends r{match(t){const e=n.Range.parse(this.value);return null!==e&&e.includes(t.tags.length)}}class c extends r{match(t){const e=n.Range.parse(this.value);return null!==e&&e.includes(t.uploaderId)}}class h extends r{match(t){switch(this.value){case"pending":return t.isPending;case"flagged":return t.isFlagged;case"deleted":return t.isDeleted;case"banned":return t.isBanned;case"child":return t.hasParent;case"parent":return t.hasChildren;default:return!1}}}class u extends r{match(t){switch(this.value){case"parent":return t.hasParent;case"children":return t.hasChildren;default:return!1}}}},776:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Post=void 0;class s{tags;score;rating;uploaderId;isPending;isFlagged;isDeleted;isBanned;hasParent;hasChildren;constructor(t,e,s,n,r,a,i,l,c,h){this.tags=t,this.score=e,this.rating=s,this.uploaderId=n,this.isPending=r,this.isFlagged=a,this.isDeleted=i,this.isBanned=l,this.hasParent=c,this.hasChildren=h}static fromElement(t){const e=t.dataset.tags.split(" "),n=parseInt(t.dataset.score),r=t.dataset.rating,a=parseInt(t.dataset.uploaderId),i=t.dataset.flags.split(" "),l=i.includes("pending"),c=i.includes("flagged"),h=i.includes("deleted"),u=i.includes("banned"),o=t.classList.contains("post-status-has-parent"),d=t.classList.contains("post-status-has-children");return new s(e,n,r,a,l,c,h,u,o,d)}}e.Post=s},125:(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.QueryParser=void 0;const n=s(302),r=s(708);class a{ast;constructor(t){this.ast=t}}class i extends a{}class l extends a{}class c extends a{}class h{static PERMITTED_UNBALANCED_TAGS=[":)",":(",";)",";(",">:)",">:("];parser;metatagRegex;constructor(t,e){this.parser=new r.StringParser(t,0),this.metatagRegex=RegExp(`(${e.join("|")}):`,"i")}static parse(t,e=[]){return new h(t,e).parse()}parse(){let t=this.root();return this.parser.eos()||(t=null),0!==this.parser.state&&(t=null),null===t?new n.ASTNone:t.simplify()}root(){const t=this.parser.zeroOrMore(this.orClause.bind(this));this.space();let e=new n.ASTAll;for(const s of t)e=new n.ASTAnd(e,s);return e}orClause(){const t=this.andClause();if(null===t)return null;if(this.space(),null!==this.parser.accept(/or +/i)){const e=this.orClause();return null===e?null:new n.ASTOr(t,e)}return t}andClause(){const t=this.factorList();if(null===t)return null;if(this.space(),null!==this.parser.accept(/and +/i)){const e=this.andClause();return null===e?null:new n.ASTAnd(t,e)}return t}factorList(){const t=this.parser.zeroOrMore(this.factor.bind(this));if(0===t.length)return null;let e=new n.ASTAll,s=new n.ASTNone;for(const r of t){let t=r.ast;r instanceof l&&(t=new n.ASTNot(t)),r instanceof c?s=new n.ASTOr(s,t):e=new n.ASTAnd(e,t)}return s instanceof n.ASTOr&&(e=new n.ASTAnd(e,s)),e}factor(){let t;this.space(),t=null!==this.parser.accept(/-/)?l:null!==this.parser.accept(/~/)?c:i;const e=this.expr();return null===e?null:new t(e)}expr(){if(this.space(),this.parser.accept(/\(/)){++this.parser.state;const t=this.orClause();return null===t||null===this.parser.accept(/\)/)?null:(--this.parser.state,t)}return this.term()}term(){return this.parser.oneOf([this.tag.bind(this),this.metatag.bind(this),this.wildcard.bind(this)])}metatag(){let t=this.parser.accept(this.metatagRegex);if(null===t)return null;t=t.slice(0,-1);const e=this.quotedString();return null===e?null:new n.ASTMetatag(t,e)}quotedString(){if(null!==this.parser.accept(/"/)){const t=this.parser.accept(/([^"\\]|\\")*/).replaceAll(/\\"/g,'"');return null===this.parser.accept(/"/)?null:t}if(null!==this.parser.accept(/'/)){const t=this.parser.accept(/([^'\\]|\\')*/).replaceAll(/\\'/g,"'");return null===this.parser.accept(/'/)?null:t}return this.string(/[^ ]*/)}wildcard(){const t=this.string(/(?=[^ ]*\*)[^ )~-][^ ]*/,!0);return null===t||0===this.metatagRegex.exec(t)?.index?null:(this.space(),new n.ASTWildcard(t))}tag(){const t=this.string(/[^ )~-][^ ]*/,!0);return null===t||["and","or"].includes(t.toLowerCase())||t.includes("*")||0===this.metatagRegex.exec(t)?.index?null:(this.space(),new n.ASTTag(t))}string(t,e=!1){let s=this.parser.accept(t);if(null===s)return null;let n=this.parser.state;for(;n-- >0&&s.endsWith(")")&&(!e||!h.hasBalancedParens(s)&&!h.PERMITTED_UNBALANCED_TAGS.includes(s));)s=s.slice(0,-1),this.parser.rewind();return s}space(){return this.parser.accept(/ */)}static hasBalancedParens(t,e="(",s=")"){let n=0;for(const r of t)if(r===e)++n;else if(r===s&&--n<0)return!1;return 0===n}}e.QueryParser=h},621:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Range=void 0;class s{static get SUBCLASSES(){return[n,r,a,h,l,c,i,o,u,d]}static parse(t){for(const e of this.SUBCLASSES){const s=e.parse(t);if(null!==s)return s}return null}static parseValue(t){return parseInt(t)}}e.Range=s;class n extends s{ranges;constructor(t){super(),this.ranges=t}static parse(t){if(null===/[, ]/.exec(t))return null;const e=[];for(const n of t.split(/[, ]+/)){const t=s.parse(n);if(null===t)return null;e.push(t)}return new this(e)}includes(t){return this.ranges.some((e=>e.includes(t)))}}class r extends s{start;end;static REGEX=/^(.+?)\.\.\.(.+)/;constructor(t,e){super(),this.start=t,this.end=e}static parse(t){const e=this.REGEX.exec(t);return null===e?null:new this(this.parseValue(e[1]),this.parseValue(e[2]))}includes(t){return this.start<=t&&t<this.end}}class a extends r{static REGEX=/^(.+?)\.\.(.+)/;includes(t){return this.start<=t&&t<=this.end}}class i extends s{value;static REGEX=/^>(.+)/;constructor(t){super(),this.value=t}static parse(t){const e=this.REGEX.exec(t);return null===e?null:new this(this.parseValue(e.filter(Boolean)[1]))}includes(t){return t>this.value}}class l extends i{static REGEX=/^<(.+)/;includes(t){return t<this.value}}class c extends i{static REGEX=/^(?:>=(.+)|(.+)\.\.$)/;includes(t){return t>=this.value}}class h extends i{static REGEX=/^(?:<=(.+)|\.\.(.+))/;includes(t){return t<=this.value}}class u extends s{static VALUE="none";static parse(t){return t!==this.VALUE?null:new this}includes(t){return Number.isNaN(t)}}class o extends u{static VALUE="any";includes(t){return!super.includes(t)}}class d extends s{value;constructor(t){super(),this.value=t}static parse(t){return new this(this.parseValue(t))}includes(t){return t===this.value}}},708:(t,e,s)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.StringParser=void 0;const n=s(998);e.StringParser=class{scanner;state;constructor(t,e){this.state=e,this.scanner=new n.StringScanner(t)}eos(){return this.scanner.hasTerminated()}accept(t){return this.scanner.scan(t)}rewind(t=1){this.scanner.setPosition(this.scanner.getPosition()-t)}backtrack(t){if(this.eos())return null;const e=this.scanner.getPosition(),s=structuredClone(this.state),n=t();return null===n&&(this.scanner.setPosition(e),this.state=s),n}zeroOrMore(t){const e=[];for(;;){const s=this.backtrack(t);if(null===s)break;e.push(s)}return e}oneOf(t){for(const e of t){const t=this.backtrack(e);if(null!==t)return t}return null}}},998:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.StringScanner=void 0,e.StringScanner=class{source;match;captures;head;last;constructor(t){this.source=t.toString(),this.reset()}scan(t){const e=t.exec(this.getRemainder());return 0===e?.index?this.setState(e,{head:this.head+e[0].length,last:this.head}):this.setState([])}scanUntil(t){const e=t.exec(this.getRemainder());return e?(this.setState(e,{head:this.head+e.index+e[0].length,last:this.head}),this.source.slice(this.last,this.head)):this.setState([])}scanChar(){return this.scan(/[\s\S]/)}skip(t){return null===this.scan(t)?null:this.match.length}skipUntil(t){return null===this.scanUntil(t)?null:this.head-this.last}check(t){const e=t.exec(this.getRemainder());return null===e||0!==e.index?this.setState([]):this.setState(e)}checkUntil(t){const e=t.exec(this.getRemainder());return null===e?this.setState([]):(this.setState(e),this.source.slice(this.head,this.head+e.index+e[0].length))}peek(t=1){return this.source.substring(this.head,this.head+t)}getSource(){return this.source}getRemainder(){return this.source.slice(this.head)}getPosition(){return this.head}hasTerminated(){return this.head===this.source.length}getPreMatch(){return null===this.match?null:this.source.slice(0,this.head-this.match.length)}getMatch(){return this.match}getPostMatch(){return null===this.match?null:this.source.slice(this.head)}getCapture(t){const e=this.captures[t];return void 0===e?null:e}reset(){this.setState([],{head:0,last:0})}terminate(){this.setState([],{head:this.source.length,last:this.head})}concat(t){this.source+=t}unscan(){const t=this.match;return null!==t&&this.setState([],{head:this.last,last:0}),t}setPosition(t){this.setState([],{head:t,last:this.head})}setState(t,{head:e,last:s}={}){return void 0!==e&&(e<0&&(e=0),this.head=e),void 0!==s&&(this.last=s),this.captures=t.slice(1),this.match=(()=>{const e=t[0];return void 0===e?null:e})(),this.match}}}},e={};function s(n){var r=e[n];if(void 0!==r)return r.exports;var a=e[n]={exports:{}};return t[n](a,a.exports,s),a.exports}(()=>{const t=s(666),e=s(776),n=s(125);$((()=>{if(0===$("#blacklist-box").length)return;Danbooru.Blacklist.post_match=(t,s)=>!s.disabled&&s.ast.match(e.Post.fromElement(t));const s=Danbooru.Blacklist.parse_entry;Danbooru.Blacklist.parse_entry=e=>{const r=s(e);return r.ast=n.QueryParser.parse(e,t.Metatag.NAMES),r},Danbooru.Blacklist.entries=[],$("#blacklist-list").empty(),$("#blacklist-box").hide(),Danbooru.Blacklist.initialize_all()}))})()})();